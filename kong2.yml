_format_version: "2.1"

services:
  # pagos
  - host: pagos_health_upstream
    name: pagos_health_service
    protocol: http
    routes:
      - name: pagos
        paths:
          - /pagos
          - /pagos/menu/
        strip_path: false
        plugins:
          - name: rate-limiting-advanced
            config:
              minute: 100
              limit_by: ip
              policy: local
              block_on_first_violation: true  # Bloquea inmediatamente la ip del atacante si se excede el límite
              fault_tolerant: false           # Asegura que si el plugin falla, no permite más peticiones
              ban_duration: 600               # Bloquea la ip del atacante durante 10 minutos (600 segundos)

  # cobros
  - host: cobros_health_upstream
    name: cobros_health_service
    protocol: http
    routes:
      - name: cobros
        paths:
          - /cobros
        strip_path: false
        plugins:
          - name: rate-limiting-advanced
            config:
              minute: 100
              limit_by: ip
              policy: local
              block_on_first_violation: true
              fault_tolerant: false
              ban_duration: 600

  # descuentos
  - host: descuentos_health_upstream
    name: descuentos_health_service
    protocol: http
    routes:
      - name: descuentos
        paths:
          - /descuentos
        strip_path: false
        plugins:
          - name: rate-limiting-advanced
            config:
              minute: 100
              limit_by: ip
              policy: local
              block_on_first_violation: true
              fault_tolerant: false
              ban_duration: 600

  # usuarios
  - host: usuarios_health_upstream
    name: usuarios_health_service
    protocol: http
    routes:
      - name: usuarios
        paths:
          - /usuarios
        strip_path: false
        plugins:
          - name: rate-limiting-advanced
            config:
              minute: 100
              limit_by: ip
              policy: local
              block_on_first_violation: true
              fault_tolerant: false
              ban_duration: 600

upstreams:
  # pagos
  - name: pagos_health_upstream
    targets:
      - target: 10.128.0.53:8080
        weight: 100

  # cobros
  - name: cobros_health_upstream
    targets:
      - target: 10.128.0.54:8080
        weight: 100

  # descuentos
  - name: descuentos_health_upstream
    targets:
      - target: 10.128.0.55:8080
        weight: 100

  # usuarios
  - name: usuarios_health_upstream
    targets:
      - target: 10.128.0.56:8080
        weight: 100
